<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹ ì²´ ë¶„ì„ | í˜„ì˜ì´ í”¼íŠ¸ë‹ˆìŠ¤</title>
  <style>
    @font-face {
    font-family: 'SBAggroB';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2108@1.1/SBAggroB.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SBAggroB';
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: #1e293b;
      padding: 20px;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      color: white;
      text-align: center;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 16px;
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 24px;
    }

    .nav-header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
    }

    .nav-header a {
      display: inline-block;
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .nav-header a:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .controls {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
    }

    .controls h3 {
      color: #2d3748;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 16px;
      text-align: center;
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 500;
      color: #374151;
      font-size: 0.9rem;
    }

    select, input[type="date"] {
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: 'SBAggroB';
      background: white;
      min-width: 140px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
    }

    .chart-card {
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      border: 1px solid #e2e8f0;
      transition: all 0.3s ease;
    }

    .chart-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .chart-card h3 {
      color: #2d3748;
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .chart-wrapper {
      position: relative;
      height: 400px;
      margin-bottom: 20px;
    }

    .stats-summary {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      text-align: center;
    }

    .stat-item {
      background: white;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .stat-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #6b7280;
      font-weight: 500;
    }

    .stat-weight { color: #3b82f6; }
    .stat-bodyfat { color: #f59e0b; }
    .stat-muscle { color: #10b981; }
    .stat-change { color: #8b5cf6; }

    .comparison-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
      background: white;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
    }

    .empty-state h3 {
      font-size: 1.4rem;
      margin-bottom: 12px;
      color: #9ca3af;
    }

    .empty-state p {
      font-size: 1rem;
      margin-bottom: 24px;
    }

    .empty-state button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .empty-state button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }

    @media (max-width: 768px) {
      .container {
        padding: 0 10px;
      }

      header {
        padding: 24px;
      }

      header h1 {
        font-size: 2rem;
      }

      .chart-wrapper {
        height: 300px;
      }

      .filter-options {
        flex-direction: column;
        gap: 12px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .comparison-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (min-width: 1200px) {
      .comparison-grid {
        grid-template-columns: 2fr 1fr;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“Š í˜„ì˜ì´ì˜ ì‹ ì²´ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
      <p>ëª¸ë¬´ê²Œ, ì²´ì§€ë°©, ê·¼ëŸ‰ ë³€í™”ë¥¼ í•œëˆˆì— ë¶„ì„í•˜ê³  íŠ¸ë Œë“œë¥¼ íŒŒì•…í•˜ì„¸ìš”</p>
      <div class="nav-header">
        <a href="index.html">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
        <a href="diary.html">ğŸ“– ìš´ë™ ê¸°ë¡</a>
        <a href="login.html">âœï¸ ê¸°ë¡ ì‘ì„±</a>
      </div>
    </header>

    <div class="controls">
      <h3>ğŸ“… ë¶„ì„ ì˜µì…˜</h3>
      <div class="filter-options">
        <div class="filter-group">
          <label>ê¸°ê°„ ì„ íƒ</label>
          <select id="periodSelect">
            <option value="all">ì „ì²´ ê¸°ê°„</option>
            <option value="30">ìµœê·¼ 30ì¼</option>
            <option value="90">ìµœê·¼ 3ê°œì›”</option>
            <option value="180">ìµœê·¼ 6ê°œì›”</option>
            <option value="365">ìµœê·¼ 1ë…„</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ì‹œì‘ ë‚ ì§œ</label>
          <input type="date" id="startDate">
        </div>
        <div class="filter-group">
          <label>ì¢…ë£Œ ë‚ ì§œ</label>
          <input type="date" id="endDate">
        </div>
        <div class="filter-group">
          <label>ì°¨íŠ¸ íƒ€ì…</label>
          <select id="chartType">
            <option value="line">ì„ í˜• ê·¸ë˜í”„</option>
            <option value="bar">ë§‰ëŒ€ ê·¸ë˜í”„</option>
            <option value="area">ì˜ì—­ ê·¸ë˜í”„</option>
          </select>
        </div>
      </div>
    </div>

    <div class="comparison-grid">
      <div class="chart-card">
        <h3>ğŸ“ˆ ì¢…í•© ì‹ ì²´ ë³€í™” ì¶”ì´</h3>
        <div class="chart-wrapper">
          <canvas id="combinedChart"></canvas>
        </div>
        <div class="stats-summary">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value stat-weight" id="avgWeight">-</div>
              <div class="stat-label">í‰ê·  ëª¸ë¬´ê²Œ</div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-bodyfat" id="avgBodyFat">-</div>
              <div class="stat-label">í‰ê·  ì²´ì§€ë°©ë¥ </div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-muscle" id="avgMuscle">-</div>
              <div class="stat-label">í‰ê·  ê·¼ëŸ‰</div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-change" id="totalChange">-</div>
              <div class="stat-label">ì´ ë³€í™”ëŸ‰</div>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-card">
        <h3>ğŸ”¥ ì²´ì§€ë°©ë¥  ë³€í™”</h3>
        <div class="chart-wrapper">
          <canvas id="bodyFatChart"></canvas>
        </div>
        <div class="stats-summary">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value stat-bodyfat" id="minBodyFat">-</div>
              <div class="stat-label">ìµœì € ì²´ì§€ë°©ë¥ </div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-bodyfat" id="maxBodyFat">-</div>
              <div class="stat-label">ìµœê³  ì²´ì§€ë°©ë¥ </div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-bodyfat" id="bodyFatChange">-</div>
              <div class="stat-label">ì²´ì§€ë°© ë³€í™”</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="comparison-grid">
      <div class="chart-card">
        <h3>ğŸ’ª ê·¼ëŸ‰ ë³€í™” ì¶”ì´</h3>
        <div class="chart-wrapper">
          <canvas id="muscleChart"></canvas>
        </div>
        <div class="stats-summary">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value stat-muscle" id="minMuscle">-</div>
              <div class="stat-label">ìµœì†Œ ê·¼ëŸ‰</div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-muscle" id="maxMuscle">-</div>
              <div class="stat-label">ìµœëŒ€ ê·¼ëŸ‰</div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-muscle" id="muscleChange">-</div>
              <div class="stat-label">ê·¼ëŸ‰ ë³€í™”</div>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-card">
        <h3>âš–ï¸ ì²´ì„±ë¶„ ë¹„ìœ¨</h3>
        <div class="chart-wrapper">
          <canvas id="compositionChart"></canvas>
        </div>
        <div class="stats-summary">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value stat-muscle" id="muscleRatio">-</div>
              <div class="stat-label">ê·¼ëŸ‰ ë¹„ìœ¨</div>
            </div>
            <div class="stat-item">
              <div class="stat-value stat-bodyfat" id="fatRatio">-</div>
              <div class="stat-label">ì²´ì§€ë°© ë¹„ìœ¨</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="otherRatio">-</div>
              <div class="stat-label">ê¸°íƒ€ ë¹„ìœ¨</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <h3>ğŸ“Š ì•„ì§ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ì–´ìš”</h3>
      <p>ìš´ë™ ê¸°ë¡ì„ ì‘ì„±í•˜ë©´ ìƒì„¸í•œ ì‹ ì²´ ë¶„ì„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
      <button onclick="window.location.href='login.html'">ì²« ìš´ë™ ê¸°ë¡ ì‘ì„±í•˜ê¸°</button>
    </div>
  </div>

  <script type="module">
    import { db } from './js/firebase.js';
    import {
      collection, getDocs
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    let combinedChart, bodyFatChart, muscleChart, compositionChart;
    let workoutLogs = [];

    function loadData() {
      const colRef = collection(db, "workoutLogs");
      getDocs(colRef).then(snapshot => {
        workoutLogs = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            ...data,
            date: data.date?.toDate() || new Date(),
            weight: data.weight || 0,
            bodyFat: data.bodyFat || 0,
            muscleMass: data.muscleMass || 0
          };
        }).filter(log => log.weight > 0 || log.bodyFat > 0 || log.muscleMass > 0);

        if (workoutLogs.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          document.querySelectorAll('.chart-card, .controls').forEach(el => el.style.display = 'none');
          return;
        }

        document.getElementById('emptyState').style.display = 'none';
        renderAllCharts();
      }).catch(error => {
        console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
        document.getElementById('emptyState').style.display = 'block';
        document.querySelector('.empty-state h3').textContent = "âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤";
        document.querySelector('.empty-state p').textContent = "í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.";
      });
    }

    function getFilteredData() {
      const period = document.getElementById('periodSelect').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      let filtered = [...workoutLogs];
      
      if (period !== 'all') {
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
        filtered = filtered.filter(log => new Date(log.date) >= cutoffDate);
      }
      
      if (startDate) {
        filtered = filtered.filter(log => log.date >= new Date(startDate));
      }
      
      if (endDate) {
        filtered = filtered.filter(log => log.date <= new Date(endDate));
      }
      
      return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    function updateStats(data) {
      if (data.length === 0) return;
      
      const weights = data.map(d => d.weight).filter(w => w > 0);
      const bodyFats = data.map(d => d.bodyFat).filter(bf => bf > 0);
      const muscles = data.map(d => d.muscleMass).filter(m => m > 0);
      
      const avgWeight = weights.length > 0 ? (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1) : '-';
      const avgBodyFat = bodyFats.length > 0 ? (bodyFats.reduce((a, b) => a + b, 0) / bodyFats.length).toFixed(1) : '-';
      const avgMuscle = muscles.length > 0 ? (muscles.reduce((a, b) => a + b, 0) / muscles.length).toFixed(1) : '-';
      
      const weightChange = weights.length > 1 ? (weights[weights.length - 1] - weights[0]).toFixed(1) : '0';
      const bodyFatChange = bodyFats.length > 1 ? (bodyFats[bodyFats.length - 1] - bodyFats[0]).toFixed(1) : '0';
      const muscleChange = muscles.length > 1 ? (muscles[muscles.length - 1] - muscles[0]).toFixed(1) : '0';
      
      const minWeight = weights.length > 0 ? Math.min(...weights).toFixed(1) : '-';
      const maxWeight = weights.length > 0 ? Math.max(...weights).toFixed(1) : '-';
      const minBodyFat = bodyFats.length > 0 ? Math.min(...bodyFats).toFixed(1) : '-';
      const maxBodyFat = bodyFats.length > 0 ? Math.max(...bodyFats).toFixed(1) : '-';
      const minMuscle = muscles.length > 0 ? Math.min(...muscles).toFixed(1) : '-';
      const maxMuscle = muscles.length > 0 ? Math.max(...muscles).toFixed(1) : '-';
      
      document.getElementById('avgWeight').textContent = avgWeight !== '-' ? avgWeight + 'kg' : '-';
      document.getElementById('avgBodyFat').textContent = avgBodyFat !== '-' ? avgBodyFat + '%' : '-';
      document.getElementById('avgMuscle').textContent = avgMuscle !== '-' ? avgMuscle + 'kg' : '-';
      document.getElementById('totalChange').textContent = 
        weightChange !== '0' ? (parseFloat(weightChange) > 0 ? '+' : '') + weightChange + 'kg' : '-';
      
      document.getElementById('minBodyFat').textContent = minBodyFat !== '-' ? minBodyFat + '%' : '-';
      document.getElementById('maxBodyFat').textContent = maxBodyFat !== '-' ? maxBodyFat + '%' : '-';
      document.getElementById('bodyFatChange').textContent = 
        bodyFatChange !== '0' ? (parseFloat(bodyFatChange) > 0 ? '+' : '') + bodyFatChange + '%' : '-';
      
      document.getElementById('minMuscle').textContent = minMuscle !== '-' ? minMuscle + 'kg' : '-';
      document.getElementById('maxMuscle').textContent = maxMuscle !== '-' ? maxMuscle + 'kg' : '-';
      document.getElementById('muscleChange').textContent = 
        muscleChange !== '0' ? (parseFloat(muscleChange) > 0 ? '+' : '') + muscleChange + 'kg' : '-';
      
      if (data.length > 0) {
        const latest = data[data.length - 1];
        if (latest.weight > 0 && latest.muscleMass > 0) {
          const muscleRatio = ((latest.muscleMass / latest.weight) * 100).toFixed(1);
          const fatRatio = latest.bodyFat.toFixed(1);
          const otherRatio = (100 - parseFloat(muscleRatio) - parseFloat(fatRatio)).toFixed(1);
          
          document.getElementById('muscleRatio').textContent = muscleRatio + '%';
          document.getElementById('fatRatio').textContent = fatRatio + '%';
          document.getElementById('otherRatio').textContent = otherRatio + '%';
        }
      }
    }

    function renderCombinedChart(data) {
      const ctx = document.getElementById('combinedChart').getContext('2d');
      const chartType = document.getElementById('chartType').value;
      
      if (combinedChart) combinedChart.destroy();
      
      const labels = data.map(d => new Date(d.date).toLocaleDateString());
      
      combinedChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels,
          datasets: [
            {
              label: 'ëª¸ë¬´ê²Œ (kg)',
              data: data.map(d => d.weight || null),
              borderColor: '#3b82f6',
              backgroundColor: chartType === 'area' ? 'rgba(59, 130, 246, 0.1)' : '#3b82f6',
              borderWidth: 3,
              fill: chartType === 'area',
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'ì²´ì§€ë°©ë¥  (%)',
              data: data.map(d => d.bodyFat || null),
              borderColor: '#f59e0b',
              backgroundColor: chartType === 'area' ? 'rgba(245, 158, 11, 0.1)' : '#f59e0b',
              borderWidth: 3,
              fill: chartType === 'area',
              tension: 0.4,
              yAxisID: 'y1'
            },
            {
              label: 'ê·¼ëŸ‰ (kg)',
              data: data.map(d => d.muscleMass || null),
              borderColor: '#10b981',
              backgroundColor: chartType === 'area' ? 'rgba(16, 185, 129, 0.1)' : '#10b981',
              borderWidth: 3,
              fill: chartType === 'area',
              tension: 0.4,
              yAxisID: 'y'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: { family: 'SBAggroB', size: 12 },
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: { family: 'SBAggroB' },
              bodyFont: { family: 'SBAggroB' },
              cornerRadius: 8
            }
          },
          scales: {
            x: {
              grid: { color: '#f1f5f9' },
              ticks: { font: { family: 'SBAggroB' } }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              grid: { color: '#f1f5f9' },
              ticks: { font: { family: 'SBAggroB' } },
              title: {
                display: true,
                text: 'ëª¸ë¬´ê²Œ / ê·¼ëŸ‰ (kg)',
                font: { family: 'SBAggroB' }
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              grid: { drawOnChartArea: false },
              ticks: { font: { family: 'SBAggroB' } },
              title: {
                display: true,
                text: 'ì²´ì§€ë°©ë¥  (%)',
                font: { family: 'SBAggroB' }
              }
            }
          }
        }
      });
    }

    function renderBodyFatChart(data) {
      const ctx = document.getElementById('bodyFatChart').getContext('2d');
      
      if (bodyFatChart) bodyFatChart.destroy();
      
      const labels = data.map(d => new Date(d.date).toLocaleDateString());
      
      bodyFatChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'ì²´ì§€ë°©ë¥  (%)',
            data: data.map(d => d.bodyFat || null),
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#f59e0b',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(245, 158, 11, 0.9)',
              titleFont: { family: 'SBAggroB' },
              bodyFont: { family: 'SBAggroB' }
            }
          },
          scales: {
            x: {
              grid: { color: '#f1f5f9' },
              ticks: { font: { family: 'SBAggroB' } }
            },
            y: {
              grid: { color: '#f1f5f9' },
              ticks: { font: { family: 'SBAggroB' } }
            }
          }
        }
      });
    }

    function renderMuscleChart(data) {
      const ctx = document.getElementById('muscleChart').getContext('2d');
      
      if (muscleChart) muscleChart.destroy();
      
      const labels = data.map(d => new Date(d.date).toLocaleDateString());
      
      muscleChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'ê·¼ëŸ‰ (kg)',
            data: data.map(d => d.muscleMass || null),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#10b981',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointRadius: 5
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(16, 185, 129, 0.9)',
              titleFont: { family: 'SBAggroB' },
              bodyFont: { family: 'SBAggroB' }
            }
          },
          scales: {
            x: {
              grid: { color: '#f1f5f9' },
              ticks: { font: { family: 'SBAggroB' } }
            },
            y: {
              grid: { color: '#f1f5f9' },
              ticks: { font: { family: 'SBAggroB' } }
            }
          }
        }
      });
    }

    function renderCompositionChart(data) {
      const ctx = document.getElementById('compositionChart').getContext('2d');
      
      if (compositionChart) compositionChart.destroy();
      
      if (data.length === 0) return;
      
      const latest = data[data.length - 1];
      if (!latest.weight || !latest.muscleMass || !latest.bodyFat) return;
      
      const muscleRatio = (latest.muscleMass / latest.weight) * 100;
      const fatRatio = latest.bodyFat;
      const otherRatio = 100 - muscleRatio - fatRatio;
      
      compositionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['ê·¼ëŸ‰', 'ì²´ì§€ë°©', 'ê¸°íƒ€ (ë¼ˆ, ìˆ˜ë¶„ ë“±)'],
          datasets: [{
            data: [muscleRatio, fatRatio, otherRatio],
            backgroundColor: [
              '#10b981',
              '#f59e0b', 
              '#6b7280'
            ],
            borderWidth: 3,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                font: { family: 'SBAggroB' },
                padding: 20,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: { family: 'SBAggroB' },
              bodyFont: { family: 'SBAggroB' },
              callbacks: {
                label: function(context) {
                  return context.label + ': ' + context.parsed.toFixed(1) + '%';
                }
              }
            }
          }
        }
      });
    }

    function renderAllCharts() {
      const filteredData = getFilteredData();
      
      if (filteredData.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        document.querySelectorAll('.chart-card').forEach(el => el.style.display = 'none');
        return;
      }

      document.getElementById('emptyState').style.display = 'none';
      document.querySelectorAll('.chart-card').forEach(el => el.style.display = 'block');
      
      updateStats(filteredData);
      renderCombinedChart(filteredData);
      renderBodyFatChart(filteredData);
      renderMuscleChart(filteredData);
      renderCompositionChart(filteredData);
    }

    document.getElementById('periodSelect').addEventListener('change', renderAllCharts);
    document.getElementById('startDate').addEventListener('change', renderAllCharts);
    document.getElementById('endDate').addEventListener('change', renderAllCharts);
    document.getElementById('chartType').addEventListener('change', renderAllCharts);

    loadData();
  </script>
</body>
</html>